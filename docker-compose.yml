services:
  web:
    build: .
    image: price-correlation:latest
    container_name: price-correlation-web
    env_file:
      - .env
    environment:
      - ENABLE_CACHE=${ENABLE_CACHE:-true}
      - ENABLE_DB_EXPORT=${ENABLE_DB_EXPORT:-true}
      - WEB_HOST=0.0.0.0
      - WEB_PORT=5000
    # ports:
    #   - "5000:5000"
    volumes:
      - ./output:/app/output
      - ./config:/app/config:ro
    # Use host network to access Redis and TimescaleDB on host machine
    network_mode: host
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/pipeline/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Usage:
#
# Start web server (default):
#   docker-compose up -d
#   Open http://localhost:5000
#
# View logs:
#   docker-compose logs -f web
#
# Stop:
#   docker-compose down
#
# Run interactive CLI instead:
#   docker-compose run --rm web python cli.py
#
# Run one-shot pipeline:
#   docker-compose run --rm web python -c "from price_correlation.pipeline import run_pipeline; run_pipeline()"
#
# Rebuild after code changes:
#   docker-compose up -d --build
