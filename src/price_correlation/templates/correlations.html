{% extends "base.html" %}

{% block title %}Correlations - Stock Clustering{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900">Correlation Pairs</h1>
        <div class="flex items-center space-x-4">
            <label class="text-sm text-gray-500">Min Correlation:</label>
            <select id="min-corr" class="border rounded px-3 py-1">
                <option value="0.9">0.90+</option>
                <option value="0.85">0.85+</option>
                <option value="0.8">0.80+</option>
                <option value="0.75">0.75+</option>
                <option value="0.7" selected>0.70+</option>
            </select>
            <button id="refresh-btn" class="btn-secondary">Refresh</button>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="text-sm text-gray-500 uppercase tracking-wide">Total Pairs</div>
            <div id="stat-pairs" class="text-3xl font-bold text-gray-900 mt-2">-</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="text-sm text-gray-500 uppercase tracking-wide">Highest Correlation</div>
            <div id="stat-max" class="text-3xl font-bold text-green-600 mt-2">-</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="text-sm text-gray-500 uppercase tracking-wide">Analysis Date</div>
            <div id="stat-date" class="text-xl font-semibold text-gray-900 mt-2">-</div>
        </div>
    </div>

    <!-- Stock Search -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Search Stock Correlations</h2>
        <div class="flex items-center space-x-4 mb-4">
            <div class="flex-1 max-w-md">
                <div class="relative">
                    <input type="text" id="stock-search" placeholder="Enter ticker symbol (e.g., AAPL)"
                           class="w-full border rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <button id="search-btn" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <button id="clear-search-btn" class="btn-secondary hidden">Clear Search</button>
        </div>

        <!-- Search Results -->
        <div id="search-results" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-4">
                    <span id="search-ticker" class="text-2xl font-bold text-blue-600">-</span>
                    <span id="search-company" class="text-gray-600">-</span>
                </div>
                <div class="text-sm text-gray-500">
                    <span id="search-count">0</span> correlated stocks
                </div>
            </div>

            <!-- Correlation strength filter for search -->
            <div class="flex items-center space-x-4 mb-4">
                <label class="text-sm text-gray-500">Filter by correlation:</label>
                <select id="search-min-corr" class="border rounded px-3 py-1 text-sm">
                    <option value="0">All</option>
                    <option value="0.5">0.50+</option>
                    <option value="0.6">0.60+</option>
                    <option value="0.7" selected>0.70+</option>
                    <option value="0.8">0.80+</option>
                    <option value="0.9">0.90+</option>
                </select>
            </div>

            <!-- Search Results Table -->
            <div class="overflow-x-auto">
                <table class="w-full table-hover">
                    <thead>
                        <tr class="text-left text-xs text-gray-500 uppercase border-b">
                            <th class="pb-3 w-8">#</th>
                            <th class="pb-3">Correlated Stock</th>
                            <th class="pb-3 text-right">Correlation</th>
                            <th class="pb-3 text-center">Strength</th>
                            <th class="pb-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="search-results-table" class="divide-y divide-gray-100">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No Results Message -->
        <div id="search-no-results" class="hidden py-8 text-center text-gray-500">
            <svg class="w-12 h-12 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p id="search-no-results-text">No correlations found for this stock</p>
        </div>

        <!-- Search Prompt -->
        <div id="search-prompt" class="py-8 text-center text-gray-500">
            <svg class="w-12 h-12 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <p>Enter a ticker symbol to find all correlated stocks</p>
        </div>
    </div>

    <!-- Correlation Distribution Chart -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Correlation Distribution</h2>
        <div class="h-48">
            <canvas id="distribution-chart"></canvas>
        </div>
    </div>

    <!-- Comparison Chart Modal -->
    <div id="compare-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 id="compare-title" class="text-lg font-semibold text-gray-900">Compare Stocks</h3>
                <button id="close-compare" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <div class="h-80">
                    <canvas id="compare-chart"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                    <div id="stock-a-stats" class="p-3 bg-blue-50 rounded">
                        <span id="stock-a-name" class="font-semibold text-blue-700">-</span>
                        <div class="text-gray-600 mt-1">Return: <span id="stock-a-return">-</span></div>
                    </div>
                    <div id="stock-b-stats" class="p-3 bg-green-50 rounded">
                        <span id="stock-b-name" class="font-semibold text-green-700">-</span>
                        <div class="text-gray-600 mt-1">Return: <span id="stock-b-return">-</span></div>
                    </div>
                </div>
                <div id="compare-correlation" class="mt-4 text-center text-gray-600">
                    Correlation: <span class="font-semibold">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Correlation Table -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Correlated Pairs</h2>
        <div class="overflow-x-auto">
            <table class="w-full table-hover">
                <thead>
                    <tr class="text-left text-xs text-gray-500 uppercase border-b">
                        <th class="pb-3 w-8">#</th>
                        <th class="pb-3">Stock A</th>
                        <th class="pb-3">Stock B</th>
                        <th class="pb-3 text-right">Correlation</th>
                        <th class="pb-3 text-center">Strength</th>
                        <th class="pb-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="pairs-table" class="divide-y divide-gray-100">
                    <tr><td colspan="6" class="py-8 text-center text-gray-400">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="load-more" class="mt-4 text-center hidden">
            <button id="load-more-btn" class="btn-secondary">Load More</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let distributionChart = null;
    let currentLimit = 50;

    function getStrengthIndicator(corr) {
        if (corr >= 0.95) return { text: 'Very Strong', class: 'bg-green-600' };
        if (corr >= 0.9) return { text: 'Strong', class: 'bg-green-500' };
        if (corr >= 0.85) return { text: 'Moderate', class: 'bg-blue-500' };
        if (corr >= 0.8) return { text: 'Fair', class: 'bg-blue-400' };
        return { text: 'Weak', class: 'bg-gray-400' };
    }

    async function loadCorrelations(limit = 50) {
        const minCorr = document.getElementById('min-corr').value;

        try {
            const res = await fetch(`/api/correlations?min_corr=${minCorr}&limit=${limit}`);
            const data = await res.json();

            document.getElementById('stat-pairs').textContent = data.count;
            document.getElementById('stat-date').textContent = data.analysis_date;

            if (data.pairs && data.pairs.length > 0) {
                document.getElementById('stat-max').textContent = data.pairs[0].correlation.toFixed(4);

                const tbody = document.getElementById('pairs-table');
                tbody.innerHTML = data.pairs.map((p, i) => {
                    const strength = getStrengthIndicator(p.correlation);
                    const barWidth = Math.round((p.correlation - 0.7) * 333); // Scale 0.7-1.0 to 0-100

                    return `
                        <tr>
                            <td class="py-3 text-sm text-gray-400">${i + 1}</td>
                            <td class="py-3">
                                <a href="/stock/${p.ticker_a}" class="text-blue-600 hover:underline font-medium">${p.ticker_a}</a>
                            </td>
                            <td class="py-3">
                                <a href="/stock/${p.ticker_b}" class="text-blue-600 hover:underline font-medium">${p.ticker_b}</a>
                            </td>
                            <td class="py-3 text-right">
                                <span class="font-mono font-semibold">${p.correlation.toFixed(4)}</span>
                            </td>
                            <td class="py-3">
                                <div class="flex items-center justify-center">
                                    <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="${strength.class} h-full" style="width: ${barWidth}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="py-3 text-center">
                                <button onclick="openCompare('${p.ticker_a}', '${p.ticker_b}', ${p.correlation})"
                                        class="text-xs bg-indigo-500 text-white px-2 py-1 rounded hover:bg-indigo-600 mr-2">
                                    Compare
                                </button>
                                <a href="/stock/${p.ticker_a}" class="text-xs text-blue-600 hover:underline mr-1">${p.ticker_a}</a>
                                <a href="/stock/${p.ticker_b}" class="text-xs text-blue-600 hover:underline">${p.ticker_b}</a>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Show load more if we got full results
                if (data.count >= limit) {
                    document.getElementById('load-more').classList.remove('hidden');
                } else {
                    document.getElementById('load-more').classList.add('hidden');
                }
            } else {
                document.getElementById('pairs-table').innerHTML =
                    '<tr><td colspan="6" class="py-8 text-center text-gray-400">No correlations found</td></tr>';
            }

            // Load distribution chart
            const chartRes = await fetch('/api/charts/correlation-distribution');
            const chartData = await chartRes.json();

            const ctx = document.getElementById('distribution-chart').getContext('2d');
            if (distributionChart) distributionChart.destroy();

            distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Number of Pairs',
                        data: chartData.data,
                        backgroundColor: 'rgba(34, 197, 94, 0.5)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

        } catch (e) {
            console.error('Error loading correlations:', e);
        }
    }

    // Event listeners
    document.getElementById('min-corr').addEventListener('change', () => {
        currentLimit = 50;
        loadCorrelations(currentLimit);
    });

    document.getElementById('refresh-btn').addEventListener('click', () => {
        currentLimit = 50;
        loadCorrelations(currentLimit);
    });

    document.getElementById('load-more-btn').addEventListener('click', () => {
        currentLimit += 50;
        loadCorrelations(currentLimit);
    });

    // Initialize
    loadCorrelations();

    // ==========================================
    // Stock Search Functionality
    // ==========================================

    let currentSearchTicker = null;
    let allSearchCorrelations = [];

    async function searchStock(ticker) {
        if (!ticker || ticker.trim() === '') return;

        ticker = ticker.trim().toUpperCase();
        currentSearchTicker = ticker;

        const searchResults = document.getElementById('search-results');
        const searchNoResults = document.getElementById('search-no-results');
        const searchPrompt = document.getElementById('search-prompt');
        const clearBtn = document.getElementById('clear-search-btn');

        // Hide prompt, show loading state
        searchPrompt.classList.add('hidden');
        searchNoResults.classList.add('hidden');
        searchResults.classList.add('hidden');

        try {
            // Fetch correlations for this stock
            const res = await fetch(`/api/stock/${ticker}/correlations?limit=500`);
            const data = await res.json();

            if (data.error) {
                searchNoResults.classList.remove('hidden');
                document.getElementById('search-no-results-text').textContent = data.error;
                clearBtn.classList.remove('hidden');
                return;
            }

            if (!data.correlations || data.correlations.length === 0) {
                searchNoResults.classList.remove('hidden');
                document.getElementById('search-no-results-text').textContent = `No correlations found for ${ticker}`;
                clearBtn.classList.remove('hidden');
                return;
            }

            // Store all correlations for filtering
            allSearchCorrelations = data.correlations;

            // Update header
            document.getElementById('search-ticker').textContent = ticker;

            // Try to fetch company name
            try {
                const infoRes = await fetch(`/api/stock/${ticker}/fundamentals`);
                const infoData = await infoRes.json();
                document.getElementById('search-company').textContent = infoData.name || '';
            } catch (e) {
                document.getElementById('search-company').textContent = '';
            }

            // Show results
            searchResults.classList.remove('hidden');
            clearBtn.classList.remove('hidden');

            // Render with current filter
            renderSearchResults();

        } catch (e) {
            console.error('Search error:', e);
            searchNoResults.classList.remove('hidden');
            document.getElementById('search-no-results-text').textContent = 'Error searching for stock';
            clearBtn.classList.remove('hidden');
        }
    }

    function renderSearchResults() {
        const minCorr = parseFloat(document.getElementById('search-min-corr').value) || 0;
        const filtered = allSearchCorrelations.filter(c => Math.abs(c.correlation) >= minCorr);

        document.getElementById('search-count').textContent = filtered.length;

        const tbody = document.getElementById('search-results-table');

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-400">No correlations above threshold</td></tr>';
            return;
        }

        tbody.innerHTML = filtered.map((c, i) => {
            const strength = getStrengthIndicator(c.correlation);
            const barWidth = Math.round((Math.abs(c.correlation) - 0.5) * 200); // Scale 0.5-1.0 to 0-100

            return `
                <tr class="hover:bg-gray-50">
                    <td class="py-3 text-sm text-gray-400">${i + 1}</td>
                    <td class="py-3">
                        <a href="/stock/${c.ticker}" class="text-blue-600 hover:underline font-medium">${c.ticker}</a>
                    </td>
                    <td class="py-3 text-right">
                        <span class="font-mono font-semibold ${c.correlation >= 0 ? 'text-green-600' : 'text-red-600'}">${c.correlation.toFixed(4)}</span>
                    </td>
                    <td class="py-3">
                        <div class="flex items-center justify-center">
                            <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="${strength.class} h-full" style="width: ${Math.min(barWidth, 100)}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="py-3 text-center">
                        <button onclick="openCompare('${currentSearchTicker}', '${c.ticker}', ${c.correlation})"
                                class="text-xs bg-indigo-500 text-white px-2 py-1 rounded hover:bg-indigo-600">
                            Compare
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function clearSearch() {
        currentSearchTicker = null;
        allSearchCorrelations = [];

        document.getElementById('stock-search').value = '';
        document.getElementById('search-results').classList.add('hidden');
        document.getElementById('search-no-results').classList.add('hidden');
        document.getElementById('search-prompt').classList.remove('hidden');
        document.getElementById('clear-search-btn').classList.add('hidden');
    }

    // Search event listeners
    document.getElementById('search-btn').addEventListener('click', () => {
        const ticker = document.getElementById('stock-search').value;
        searchStock(ticker);
    });

    document.getElementById('stock-search').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const ticker = document.getElementById('stock-search').value;
            searchStock(ticker);
        }
    });

    document.getElementById('clear-search-btn').addEventListener('click', clearSearch);

    document.getElementById('search-min-corr').addEventListener('change', () => {
        if (currentSearchTicker && allSearchCorrelations.length > 0) {
            renderSearchResults();
        }
    });

    // ==========================================
    // End Stock Search Functionality
    // ==========================================

    // Open comparison in new popup window
    function openCompare(tickerA, tickerB, correlation) {
        const url = `/compare/${tickerA}/${tickerB}?corr=${correlation.toFixed(4)}`;
        const width = 1200;
        const height = 900;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        window.open(url, '_blank', `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes`);
    }

    // Comparison chart (legacy modal - kept for reference)
    let compareChart = null;

    async function comparePair(tickerA, tickerB, correlation) {
        const modal = document.getElementById('compare-modal');
        modal.classList.remove('hidden');

        document.getElementById('compare-title').textContent = `${tickerA} vs ${tickerB}`;
        document.getElementById('stock-a-name').textContent = tickerA;
        document.getElementById('stock-b-name').textContent = tickerB;
        document.getElementById('compare-correlation').querySelector('span').textContent = correlation.toFixed(4);

        try {
            // Fetch price data for both stocks
            const [resA, resB] = await Promise.all([
                fetch(`/api/stock/${tickerA}/prices`),
                fetch(`/api/stock/${tickerB}/prices`)
            ]);

            const dataA = await resA.json();
            const dataB = await resB.json();

            if (!dataA.prices || !dataB.prices) {
                console.error('No price data available');
                return;
            }

            // Normalize prices to percentage return from start
            const pricesA = dataA.prices;
            const pricesB = dataB.prices;

            const startA = pricesA[0].price;
            const startB = pricesB[0].price;
            const endA = pricesA[pricesA.length - 1].price;
            const endB = pricesB[pricesB.length - 1].price;

            const returnA = ((endA - startA) / startA * 100).toFixed(1);
            const returnB = ((endB - startB) / startB * 100).toFixed(1);

            document.getElementById('stock-a-return').textContent = `${returnA}%`;
            document.getElementById('stock-b-return').textContent = `${returnB}%`;

            // Normalize both to start at 100 for easier comparison
            const normalizedA = pricesA.map(p => ({
                date: p.date,
                value: (p.price / startA) * 100
            }));
            const normalizedB = pricesB.map(p => ({
                date: p.date,
                value: (p.price / startB) * 100
            }));

            // Create chart
            const ctx = document.getElementById('compare-chart').getContext('2d');
            if (compareChart) compareChart.destroy();

            compareChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: normalizedA.map(p => p.date),
                    datasets: [
                        {
                            label: tickerA,
                            data: normalizedA.map(p => p.value),
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: tickerB,
                            data: normalizedB.map(p => p.value),
                            borderColor: 'rgba(34, 197, 94, 1)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${(context.raw - 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            ticks: {
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Indexed Price (Start = 100)'
                            }
                        }
                    }
                }
            });

        } catch (e) {
            console.error('Error loading comparison data:', e);
        }
    }

    // Close modal handlers
    document.getElementById('close-compare').addEventListener('click', () => {
        document.getElementById('compare-modal').classList.add('hidden');
    });

    document.getElementById('compare-modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            document.getElementById('compare-modal').classList.add('hidden');
        }
    });

    // Close on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.getElementById('compare-modal').classList.add('hidden');
        }
    });
</script>
{% endblock %}
