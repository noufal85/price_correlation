{% extends "base.html" %}

{% block title %}Correlations - Stock Clustering{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900">Correlation Pairs</h1>
        <div class="flex items-center space-x-4">
            <label class="text-sm text-gray-500">Min Correlation:</label>
            <select id="min-corr" class="border rounded px-3 py-1">
                <option value="0.9">0.90+</option>
                <option value="0.85">0.85+</option>
                <option value="0.8">0.80+</option>
                <option value="0.75">0.75+</option>
                <option value="0.7" selected>0.70+</option>
            </select>
            <button id="refresh-btn" class="btn-secondary">Refresh</button>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="text-sm text-gray-500 uppercase tracking-wide">Total Pairs</div>
            <div id="stat-pairs" class="text-3xl font-bold text-gray-900 mt-2">-</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="text-sm text-gray-500 uppercase tracking-wide">Highest Correlation</div>
            <div id="stat-max" class="text-3xl font-bold text-green-600 mt-2">-</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="text-sm text-gray-500 uppercase tracking-wide">Analysis Date</div>
            <div id="stat-date" class="text-xl font-semibold text-gray-900 mt-2">-</div>
        </div>
    </div>

    <!-- Stock Search -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Search Stock Correlations</h2>
        <div class="flex items-center space-x-4 mb-4">
            <div class="flex-1 max-w-md">
                <div class="relative">
                    <input type="text" id="stock-search" placeholder="Enter ticker symbol (e.g., AAPL)"
                           class="w-full border rounded-lg px-4 py-2 pr-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <button id="search-btn" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <button id="clear-search-btn" class="btn-secondary hidden">Clear Search</button>
        </div>

        <!-- Search Results -->
        <div id="search-results" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-4">
                    <span id="search-ticker" class="text-2xl font-bold text-blue-600">-</span>
                    <span id="search-company" class="text-gray-600">-</span>
                </div>
                <div class="text-sm text-gray-500">
                    <span id="search-count">0</span> correlated stocks
                </div>
            </div>

            <!-- Correlation strength filter for search -->
            <div class="flex items-center space-x-4 mb-4">
                <label class="text-sm text-gray-500">Filter by correlation:</label>
                <select id="search-min-corr" class="border rounded px-3 py-1 text-sm">
                    <option value="0">All</option>
                    <option value="0.5">0.50+</option>
                    <option value="0.6">0.60+</option>
                    <option value="0.7" selected>0.70+</option>
                    <option value="0.8">0.80+</option>
                    <option value="0.9">0.90+</option>
                </select>
            </div>

            <!-- Search Results Table -->
            <div class="overflow-x-auto">
                <table class="w-full table-hover">
                    <thead>
                        <tr class="text-left text-xs text-gray-500 uppercase border-b">
                            <th class="pb-3 w-8">#</th>
                            <th class="pb-3">Correlated Stock</th>
                            <th class="pb-3">Sector</th>
                            <th class="pb-3">Industry</th>
                            <th class="pb-3 text-right">Correlation</th>
                            <th class="pb-3 text-center">Strength</th>
                            <th class="pb-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="search-results-table" class="divide-y divide-gray-100">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No Results Message -->
        <div id="search-no-results" class="hidden py-8 text-center text-gray-500">
            <svg class="w-12 h-12 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p id="search-no-results-text">No correlations found for this stock</p>
        </div>

        <!-- Search Prompt -->
        <div id="search-prompt" class="py-8 text-center text-gray-500">
            <svg class="w-12 h-12 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <p>Enter a ticker symbol to find all correlated stocks</p>
        </div>
    </div>

    <!-- Correlation Distribution Chart -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Correlation Distribution</h2>
        <div class="h-48">
            <canvas id="distribution-chart"></canvas>
        </div>
    </div>

    <!-- Stock Detail Modal -->
    <div id="stock-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center border-b px-6 py-4 bg-gray-50">
                <div class="flex items-center space-x-4">
                    <h3 id="modal-ticker" class="text-xl font-bold text-gray-900">-</h3>
                    <span id="modal-company" class="text-gray-500">-</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div id="modal-price" class="text-xl font-bold">-</div>
                        <div id="modal-change" class="text-sm">-</div>
                    </div>
                    <button id="close-stock-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <!-- Company Info -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-50 rounded p-3">
                        <div class="text-xs text-gray-500">Sector</div>
                        <div id="modal-sector" class="font-medium">-</div>
                    </div>
                    <div class="bg-gray-50 rounded p-3">
                        <div class="text-xs text-gray-500">Industry</div>
                        <div id="modal-industry" class="font-medium">-</div>
                    </div>
                    <div class="bg-gray-50 rounded p-3">
                        <div class="text-xs text-gray-500">Market Cap</div>
                        <div id="modal-marketcap" class="font-medium">-</div>
                    </div>
                    <div class="bg-gray-50 rounded p-3">
                        <div class="text-xs text-gray-500">Exchange</div>
                        <div id="modal-exchange" class="font-medium">-</div>
                    </div>
                </div>

                <!-- Two column layout -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Price Chart -->
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Price History (30 Days)</h4>
                        <div class="h-48">
                            <canvas id="modal-price-chart"></canvas>
                        </div>
                    </div>

                    <!-- Cluster Info -->
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Cluster Information</h4>
                        <div id="modal-cluster-info" class="text-gray-400">Loading...</div>
                    </div>
                </div>

                <!-- Correlations and Peers -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Most Correlated Stocks</h4>
                        <div id="modal-correlations" class="space-y-1 max-h-40 overflow-y-auto text-gray-400">Loading...</div>
                    </div>
                    <div class="bg-white border rounded-lg p-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Similar Companies (FMP)</h4>
                        <div id="modal-peers" class="space-y-1 max-h-40 overflow-y-auto text-gray-400">Loading...</div>
                    </div>
                </div>

                <!-- Financial Ratios -->
                <div class="bg-white border rounded-lg p-4 mb-6">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Key Financial Ratios</h4>
                    <div id="modal-ratios" class="grid grid-cols-3 md:grid-cols-6 gap-3 text-gray-400">Loading...</div>
                </div>

                <!-- News -->
                <div class="bg-white border rounded-lg p-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Recent News</h4>
                    <div id="modal-news" class="space-y-3 max-h-48 overflow-y-auto text-gray-400">Loading...</div>
                </div>
            </div>
            <div class="border-t px-6 py-3 bg-gray-50 flex justify-between items-center">
                <a id="modal-full-page-link" href="#" class="text-blue-600 hover:underline text-sm">Open full page</a>
                <button onclick="closeStockModal()" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Comparison Chart Modal -->
    <div id="compare-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 id="compare-title" class="text-lg font-semibold text-gray-900">Compare Stocks</h3>
                <button id="close-compare" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <div class="h-80">
                    <canvas id="compare-chart"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                    <div id="stock-a-stats" class="p-3 bg-blue-50 rounded">
                        <span id="stock-a-name" class="font-semibold text-blue-700">-</span>
                        <div class="text-gray-600 mt-1">Return: <span id="stock-a-return">-</span></div>
                    </div>
                    <div id="stock-b-stats" class="p-3 bg-green-50 rounded">
                        <span id="stock-b-name" class="font-semibold text-green-700">-</span>
                        <div class="text-gray-600 mt-1">Return: <span id="stock-b-return">-</span></div>
                    </div>
                </div>
                <div id="compare-correlation" class="mt-4 text-center text-gray-600">
                    Correlation: <span class="font-semibold">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Correlation Table -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Correlated Pairs</h2>
        <div class="overflow-x-auto">
            <table class="w-full table-hover">
                <thead>
                    <tr class="text-left text-xs text-gray-500 uppercase border-b">
                        <th class="pb-3 w-8">#</th>
                        <th class="pb-3">Stock A</th>
                        <th class="pb-3">Stock B</th>
                        <th class="pb-3 text-right">Correlation</th>
                        <th class="pb-3 text-center">Strength</th>
                        <th class="pb-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="pairs-table" class="divide-y divide-gray-100">
                    <tr><td colspan="6" class="py-8 text-center text-gray-400">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="load-more" class="mt-4 text-center hidden">
            <button id="load-more-btn" class="btn-secondary">Load More</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let distributionChart = null;
    let currentLimit = 50;
    let modalPriceChart = null;

    // Format large numbers
    function formatNumber(num) {
        if (!num) return '-';
        if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
        if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
        if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
        if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
        return num.toFixed(2);
    }

    function getStrengthIndicator(corr) {
        if (corr >= 0.95) return { text: 'Very Strong', class: 'bg-green-600' };
        if (corr >= 0.9) return { text: 'Strong', class: 'bg-green-500' };
        if (corr >= 0.85) return { text: 'Moderate', class: 'bg-blue-500' };
        if (corr >= 0.8) return { text: 'Fair', class: 'bg-blue-400' };
        return { text: 'Weak', class: 'bg-gray-400' };
    }

    async function loadCorrelations(limit = 50) {
        const minCorr = document.getElementById('min-corr').value;

        try {
            const res = await fetch(`/api/correlations?min_corr=${minCorr}&limit=${limit}`);
            const data = await res.json();

            document.getElementById('stat-pairs').textContent = data.count;
            document.getElementById('stat-date').textContent = data.analysis_date;

            if (data.pairs && data.pairs.length > 0) {
                document.getElementById('stat-max').textContent = data.pairs[0].correlation.toFixed(4);

                const tbody = document.getElementById('pairs-table');
                tbody.innerHTML = data.pairs.map((p, i) => {
                    const strength = getStrengthIndicator(p.correlation);
                    const barWidth = Math.round((p.correlation - 0.7) * 333); // Scale 0.7-1.0 to 0-100

                    return `
                        <tr>
                            <td class="py-3 text-sm text-gray-400">${i + 1}</td>
                            <td class="py-3">
                                <button onclick="openStockModal('${p.ticker_a}', '${p.ticker_b}')" class="text-blue-600 hover:underline font-medium">${p.ticker_a}</button>
                            </td>
                            <td class="py-3">
                                <button onclick="openStockModal('${p.ticker_b}', '${p.ticker_a}')" class="text-blue-600 hover:underline font-medium">${p.ticker_b}</button>
                            </td>
                            <td class="py-3 text-right">
                                <span class="font-mono font-semibold">${p.correlation.toFixed(4)}</span>
                            </td>
                            <td class="py-3">
                                <div class="flex items-center justify-center">
                                    <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="${strength.class} h-full" style="width: ${barWidth}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="py-3 text-center">
                                <button onclick="openCompare('${p.ticker_a}', '${p.ticker_b}', ${p.correlation})"
                                        class="text-xs bg-indigo-500 text-white px-2 py-1 rounded hover:bg-indigo-600">
                                    Compare
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Show load more if we got full results
                if (data.count >= limit) {
                    document.getElementById('load-more').classList.remove('hidden');
                } else {
                    document.getElementById('load-more').classList.add('hidden');
                }
            } else {
                document.getElementById('pairs-table').innerHTML =
                    '<tr><td colspan="6" class="py-8 text-center text-gray-400">No correlations found</td></tr>';
            }

            // Load distribution chart
            const chartRes = await fetch('/api/charts/correlation-distribution');
            const chartData = await chartRes.json();

            const ctx = document.getElementById('distribution-chart').getContext('2d');
            if (distributionChart) distributionChart.destroy();

            distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Number of Pairs',
                        data: chartData.data,
                        backgroundColor: 'rgba(34, 197, 94, 0.5)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

        } catch (e) {
            console.error('Error loading correlations:', e);
        }
    }

    // Event listeners
    document.getElementById('min-corr').addEventListener('change', () => {
        currentLimit = 50;
        loadCorrelations(currentLimit);
    });

    document.getElementById('refresh-btn').addEventListener('click', () => {
        currentLimit = 50;
        loadCorrelations(currentLimit);
    });

    document.getElementById('load-more-btn').addEventListener('click', () => {
        currentLimit += 50;
        loadCorrelations(currentLimit);
    });

    // Initialize
    loadCorrelations();

    // ==========================================
    // Stock Search Functionality
    // ==========================================

    let currentSearchTicker = null;
    let allSearchCorrelations = [];

    async function searchStock(ticker) {
        if (!ticker || ticker.trim() === '') return;

        ticker = ticker.trim().toUpperCase();
        currentSearchTicker = ticker;

        const searchResults = document.getElementById('search-results');
        const searchNoResults = document.getElementById('search-no-results');
        const searchPrompt = document.getElementById('search-prompt');
        const clearBtn = document.getElementById('clear-search-btn');

        // Hide prompt, show loading state
        searchPrompt.classList.add('hidden');
        searchNoResults.classList.add('hidden');
        searchResults.classList.add('hidden');

        try {
            // Fetch correlations for this stock
            const res = await fetch(`/api/stock/${ticker}/correlations?limit=500`);
            const data = await res.json();

            if (data.error) {
                searchNoResults.classList.remove('hidden');
                document.getElementById('search-no-results-text').textContent = data.error;
                clearBtn.classList.remove('hidden');
                return;
            }

            if (!data.correlations || data.correlations.length === 0) {
                searchNoResults.classList.remove('hidden');
                document.getElementById('search-no-results-text').textContent = `No correlations found for ${ticker}`;
                clearBtn.classList.remove('hidden');
                return;
            }

            // Store all correlations for filtering
            allSearchCorrelations = data.correlations;

            // Update header
            document.getElementById('search-ticker').textContent = ticker;

            // Try to fetch company name
            try {
                const infoRes = await fetch(`/api/stock/${ticker}/fundamentals`);
                const infoData = await infoRes.json();
                document.getElementById('search-company').textContent = infoData.name || '';
            } catch (e) {
                document.getElementById('search-company').textContent = '';
            }

            // Show results
            searchResults.classList.remove('hidden');
            clearBtn.classList.remove('hidden');

            // Render with current filter
            renderSearchResults();

        } catch (e) {
            console.error('Search error:', e);
            searchNoResults.classList.remove('hidden');
            document.getElementById('search-no-results-text').textContent = 'Error searching for stock';
            clearBtn.classList.remove('hidden');
        }
    }

    // Cache for stock profiles
    let stockProfileCache = {};

    function renderSearchResults() {
        const minCorr = parseFloat(document.getElementById('search-min-corr').value) || 0;
        const filtered = allSearchCorrelations.filter(c => Math.abs(c.correlation) >= minCorr);

        document.getElementById('search-count').textContent = filtered.length;

        const tbody = document.getElementById('search-results-table');

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-400">No correlations above threshold</td></tr>';
            return;
        }

        tbody.innerHTML = filtered.map((c, i) => {
            const strength = getStrengthIndicator(c.correlation);
            const barWidth = Math.round((Math.abs(c.correlation) - 0.5) * 200); // Scale 0.5-1.0 to 0-100
            const cached = stockProfileCache[c.ticker];

            return `
                <tr class="hover:bg-gray-50" data-ticker="${c.ticker}">
                    <td class="py-3 text-sm text-gray-400">${i + 1}</td>
                    <td class="py-3">
                        <button onclick="openStockModal('${c.ticker}', '${currentSearchTicker}')" class="text-blue-600 hover:underline font-medium">${c.ticker}</button>
                        <div class="text-xs text-gray-500 stock-name" data-ticker="${c.ticker}">${cached?.companyName || ''}</div>
                    </td>
                    <td class="py-3 text-sm stock-sector" data-ticker="${c.ticker}">${cached?.sector || '<span class="text-gray-300">Loading...</span>'}</td>
                    <td class="py-3 text-sm stock-industry" data-ticker="${c.ticker}">${cached?.industry || '<span class="text-gray-300">Loading...</span>'}</td>
                    <td class="py-3 text-right">
                        <span class="font-mono font-semibold ${c.correlation >= 0 ? 'text-green-600' : 'text-red-600'}">${c.correlation.toFixed(4)}</span>
                    </td>
                    <td class="py-3">
                        <div class="flex items-center justify-center">
                            <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="${strength.class} h-full" style="width: ${Math.min(barWidth, 100)}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="py-3 text-center">
                        <button onclick="openCompare('${currentSearchTicker}', '${c.ticker}', ${c.correlation})"
                                class="text-xs bg-indigo-500 text-white px-2 py-1 rounded hover:bg-indigo-600">
                            Compare
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        // Fetch profiles for stocks not in cache
        const tickersToFetch = filtered
            .map(c => c.ticker)
            .filter(t => !stockProfileCache[t]);

        if (tickersToFetch.length > 0) {
            fetchStockProfiles(tickersToFetch);
        }
    }

    async function fetchStockProfiles(tickers) {
        // Fetch profiles in parallel (limit to 10 at a time to avoid overwhelming the API)
        const batchSize = 10;
        for (let i = 0; i < tickers.length; i += batchSize) {
            const batch = tickers.slice(i, i + batchSize);
            const promises = batch.map(async (ticker) => {
                try {
                    const res = await fetch(`/api/fmp/profile/${ticker}`);
                    const data = await res.json();
                    if (data && !data.error) {
                        stockProfileCache[ticker] = data;
                        updateStockProfileInTable(ticker, data);
                    }
                } catch (e) {
                    console.error(`Error fetching profile for ${ticker}:`, e);
                }
            });
            await Promise.all(promises);
        }
    }

    function updateStockProfileInTable(ticker, profile) {
        // Update company name
        const nameEls = document.querySelectorAll(`.stock-name[data-ticker="${ticker}"]`);
        nameEls.forEach(el => {
            el.textContent = profile.companyName || '';
        });

        // Update sector
        const sectorEls = document.querySelectorAll(`.stock-sector[data-ticker="${ticker}"]`);
        sectorEls.forEach(el => {
            el.textContent = profile.sector || '-';
        });

        // Update industry
        const industryEls = document.querySelectorAll(`.stock-industry[data-ticker="${ticker}"]`);
        industryEls.forEach(el => {
            el.textContent = profile.industry || '-';
        });
    }

    function clearSearch() {
        currentSearchTicker = null;
        allSearchCorrelations = [];

        document.getElementById('stock-search').value = '';
        document.getElementById('search-results').classList.add('hidden');
        document.getElementById('search-no-results').classList.add('hidden');
        document.getElementById('search-prompt').classList.remove('hidden');
        document.getElementById('clear-search-btn').classList.add('hidden');
    }

    // Search event listeners
    document.getElementById('search-btn').addEventListener('click', () => {
        const ticker = document.getElementById('stock-search').value;
        searchStock(ticker);
    });

    document.getElementById('stock-search').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const ticker = document.getElementById('stock-search').value;
            searchStock(ticker);
        }
    });

    document.getElementById('clear-search-btn').addEventListener('click', clearSearch);

    document.getElementById('search-min-corr').addEventListener('change', () => {
        if (currentSearchTicker && allSearchCorrelations.length > 0) {
            renderSearchResults();
        }
    });

    // ==========================================
    // End Stock Search Functionality
    // ==========================================

    // Open comparison in new popup window
    function openCompare(tickerA, tickerB, correlation) {
        const url = `/compare/${tickerA}/${tickerB}?corr=${correlation.toFixed(4)}`;
        const width = 1200;
        const height = 900;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        window.open(url, '_blank', `width=${width},height=${height},left=${left},top=${top},scrollbars=yes,resizable=yes`);
    }

    // Comparison chart (legacy modal - kept for reference)
    let compareChart = null;

    async function comparePair(tickerA, tickerB, correlation) {
        const modal = document.getElementById('compare-modal');
        modal.classList.remove('hidden');

        document.getElementById('compare-title').textContent = `${tickerA} vs ${tickerB}`;
        document.getElementById('stock-a-name').textContent = tickerA;
        document.getElementById('stock-b-name').textContent = tickerB;
        document.getElementById('compare-correlation').querySelector('span').textContent = correlation.toFixed(4);

        try {
            // Fetch price data for both stocks
            const [resA, resB] = await Promise.all([
                fetch(`/api/stock/${tickerA}/prices`),
                fetch(`/api/stock/${tickerB}/prices`)
            ]);

            const dataA = await resA.json();
            const dataB = await resB.json();

            if (!dataA.prices || !dataB.prices) {
                console.error('No price data available');
                return;
            }

            // Normalize prices to percentage return from start
            const pricesA = dataA.prices;
            const pricesB = dataB.prices;

            const startA = pricesA[0].price;
            const startB = pricesB[0].price;
            const endA = pricesA[pricesA.length - 1].price;
            const endB = pricesB[pricesB.length - 1].price;

            const returnA = ((endA - startA) / startA * 100).toFixed(1);
            const returnB = ((endB - startB) / startB * 100).toFixed(1);

            document.getElementById('stock-a-return').textContent = `${returnA}%`;
            document.getElementById('stock-b-return').textContent = `${returnB}%`;

            // Normalize both to start at 100 for easier comparison
            const normalizedA = pricesA.map(p => ({
                date: p.date,
                value: (p.price / startA) * 100
            }));
            const normalizedB = pricesB.map(p => ({
                date: p.date,
                value: (p.price / startB) * 100
            }));

            // Create chart
            const ctx = document.getElementById('compare-chart').getContext('2d');
            if (compareChart) compareChart.destroy();

            compareChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: normalizedA.map(p => p.date),
                    datasets: [
                        {
                            label: tickerA,
                            data: normalizedA.map(p => p.value),
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: tickerB,
                            data: normalizedB.map(p => p.value),
                            borderColor: 'rgba(34, 197, 94, 1)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${(context.raw - 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            ticks: {
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Indexed Price (Start = 100)'
                            }
                        }
                    }
                }
            });

        } catch (e) {
            console.error('Error loading comparison data:', e);
        }
    }

    // ==========================================
    // Stock Detail Modal Functions
    // ==========================================

    async function openStockModal(ticker, pairedTicker = null) {
        const modal = document.getElementById('stock-modal');
        modal.classList.remove('hidden');

        // Reset all fields
        document.getElementById('modal-ticker').textContent = ticker;
        document.getElementById('modal-company').textContent = 'Loading...';
        document.getElementById('modal-price').textContent = '-';
        document.getElementById('modal-change').textContent = '-';
        document.getElementById('modal-sector').textContent = '-';
        document.getElementById('modal-industry').textContent = '-';
        document.getElementById('modal-marketcap').textContent = '-';
        document.getElementById('modal-exchange').textContent = '-';
        document.getElementById('modal-cluster-info').innerHTML = '<span class="text-gray-400">Loading...</span>';
        document.getElementById('modal-correlations').innerHTML = '<span class="text-gray-400">Loading...</span>';
        document.getElementById('modal-peers').innerHTML = '<span class="text-gray-400">Loading...</span>';
        document.getElementById('modal-ratios').innerHTML = '<span class="text-gray-400">Loading...</span>';
        document.getElementById('modal-news').innerHTML = '<span class="text-gray-400">Loading...</span>';
        document.getElementById('modal-full-page-link').href = `/stock/${ticker}`;

        // Load all data in parallel
        loadModalProfile(ticker);
        loadModalQuote(ticker);
        loadModalPriceChart(ticker, pairedTicker);
        loadModalClusterInfo(ticker);
        loadModalCorrelations(ticker);
        loadModalPeers(ticker);
        loadModalRatios(ticker);
        loadModalNews(ticker);
    }

    function closeStockModal() {
        document.getElementById('stock-modal').classList.add('hidden');
        if (modalPriceChart) {
            modalPriceChart.destroy();
            modalPriceChart = null;
        }
    }

    async function loadModalProfile(ticker) {
        try {
            const res = await fetch(`/api/fmp/profile/${ticker}`);
            const data = await res.json();
            if (data.companyName) {
                document.getElementById('modal-company').textContent = data.companyName;
                document.getElementById('modal-sector').textContent = data.sector || '-';
                document.getElementById('modal-industry').textContent = data.industry || '-';
                document.getElementById('modal-marketcap').textContent = data.mktCap ? formatNumber(data.mktCap) : '-';
                document.getElementById('modal-exchange').textContent = data.exchangeShortName || data.exchange || '-';
            }
        } catch (e) {
            console.error('Error loading profile:', e);
        }
    }

    async function loadModalQuote(ticker) {
        try {
            const res = await fetch(`/api/fmp/quote/${ticker}`);
            const data = await res.json();
            if (data.price) {
                document.getElementById('modal-price').textContent = '$' + data.price.toFixed(2);
                const change = data.change || 0;
                const changePct = data.changesPercentage || 0;
                const isPositive = change >= 0;
                const changeEl = document.getElementById('modal-change');
                changeEl.textContent = `${isPositive ? '+' : ''}${change.toFixed(2)} (${isPositive ? '+' : ''}${changePct.toFixed(2)}%)`;
                changeEl.className = `text-sm ${isPositive ? 'text-green-600' : 'text-red-600'}`;
            }
        } catch (e) {
            console.error('Error loading quote:', e);
        }
    }

    async function loadModalPriceChart(ticker, pairedTicker) {
        try {
            // Fetch data for primary ticker
            const res = await fetch(`/api/fmp/historical/${ticker}?days=30`);
            const data = await res.json();

            let datasets = [];
            let labels = [];

            if (data.historical && data.historical.length > 0) {
                const reversed = data.historical.reverse();
                labels = reversed.map(d => d.date);
                const startPrice = reversed[0].close;
                const normalized = reversed.map(d => (d.close / startPrice) * 100);

                datasets.push({
                    label: ticker,
                    data: normalized,
                    borderColor: 'rgba(59, 130, 246, 1)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                });
            }

            // If paired ticker provided, add it to chart
            if (pairedTicker) {
                try {
                    const res2 = await fetch(`/api/fmp/historical/${pairedTicker}?days=30`);
                    const data2 = await res2.json();
                    if (data2.historical && data2.historical.length > 0) {
                        const reversed2 = data2.historical.reverse();
                        const startPrice2 = reversed2[0].close;
                        const normalized2 = reversed2.map(d => (d.close / startPrice2) * 100);

                        datasets.push({
                            label: pairedTicker,
                            data: normalized2,
                            borderColor: 'rgba(34, 197, 94, 1)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        });
                    }
                } catch (e) {
                    console.error('Error loading paired ticker:', e);
                }
            }

            const ctx = document.getElementById('modal-price-chart').getContext('2d');
            if (modalPriceChart) modalPriceChart.destroy();

            modalPriceChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: datasets.length > 1, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${(ctx.raw - 100).toFixed(1)}%`
                            }
                        }
                    },
                    scales: {
                        x: { display: true, ticks: { maxTicksLimit: 6 } },
                        y: { display: true, title: { display: true, text: 'Indexed (Start=100)' } }
                    }
                }
            });
        } catch (e) {
            console.error('Error loading price chart:', e);
        }
    }

    async function loadModalClusterInfo(ticker) {
        try {
            const res = await fetch(`/api/stock/${ticker}/cluster-history`);
            const data = await res.json();
            const container = document.getElementById('modal-cluster-info');

            if (data.history && data.history.length > 0) {
                const latest = data.history[0];
                container.innerHTML = `
                    <div class="flex justify-between items-center p-2 bg-blue-50 rounded mb-2">
                        <span class="text-sm">Current Cluster</span>
                        <span class="font-bold text-blue-600">${latest.cluster_id === -1 ? 'Noise' : 'Cluster ' + latest.cluster_id}</span>
                    </div>
                    <div class="text-xs text-gray-500">As of ${latest.date}</div>
                `;
            } else {
                container.innerHTML = '<span class="text-gray-400">No cluster data</span>';
            }
        } catch (e) {
            console.error('Error loading cluster info:', e);
        }
    }

    async function loadModalCorrelations(ticker) {
        try {
            const res = await fetch(`/api/stock/${ticker}/correlations?limit=10`);
            const data = await res.json();
            const container = document.getElementById('modal-correlations');

            if (data.correlations && data.correlations.length > 0) {
                container.innerHTML = data.correlations.map(c => `
                    <div class="flex justify-between items-center py-1 text-sm">
                        <button onclick="openStockModal('${c.ticker}', '${ticker}')" class="text-blue-600 hover:underline">${c.ticker}</button>
                        <span class="font-mono">${c.correlation.toFixed(4)}</span>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<span class="text-gray-400">No correlations</span>';
            }
        } catch (e) {
            console.error('Error loading correlations:', e);
        }
    }

    async function loadModalPeers(ticker) {
        try {
            const res = await fetch(`/api/fmp/peers/${ticker}`);
            const data = await res.json();
            const container = document.getElementById('modal-peers');

            if (data.peersList && data.peersList.length > 0) {
                container.innerHTML = data.peersList.slice(0, 8).map(peer => `
                    <div class="py-1 text-sm">
                        <button onclick="openStockModal('${peer}', '${ticker}')" class="text-blue-600 hover:underline">${peer}</button>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<span class="text-gray-400">No peer data</span>';
            }
        } catch (e) {
            console.error('Error loading peers:', e);
        }
    }

    async function loadModalRatios(ticker) {
        try {
            const res = await fetch(`/api/fmp/ratios/${ticker}`);
            const data = await res.json();
            const container = document.getElementById('modal-ratios');

            const ratios = [
                { label: 'P/E', value: data.peRatioTTM },
                { label: 'P/B', value: data.priceToBookRatioTTM },
                { label: 'ROE', value: data.returnOnEquityTTM, pct: true },
                { label: 'ROA', value: data.returnOnAssetsTTM, pct: true },
                { label: 'D/E', value: data.debtEquityRatioTTM },
                { label: 'Current', value: data.currentRatioTTM },
            ];

            container.innerHTML = ratios.map(r => `
                <div class="bg-gray-50 rounded p-2 text-center">
                    <div class="text-xs text-gray-500">${r.label}</div>
                    <div class="font-semibold">${r.value ? (r.pct ? (r.value * 100).toFixed(1) + '%' : r.value.toFixed(2)) : '-'}</div>
                </div>
            `).join('');
        } catch (e) {
            console.error('Error loading ratios:', e);
        }
    }

    async function loadModalNews(ticker) {
        try {
            const res = await fetch(`/api/fmp/news/${ticker}?limit=3`);
            const news = await res.json();
            const container = document.getElementById('modal-news');

            if (news && news.length > 0) {
                container.innerHTML = news.map(n => `
                    <div class="border-b pb-2 last:border-0">
                        <a href="${n.url}" target="_blank" class="text-blue-600 hover:underline text-sm font-medium">${n.title}</a>
                        <div class="text-xs text-gray-500">${n.site} - ${new Date(n.publishedDate).toLocaleDateString()}</div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<span class="text-gray-400">No news</span>';
            }
        } catch (e) {
            console.error('Error loading news:', e);
        }
    }

    // Close modal handlers
    document.getElementById('close-compare').addEventListener('click', () => {
        document.getElementById('compare-modal').classList.add('hidden');
    });

    document.getElementById('close-stock-modal').addEventListener('click', closeStockModal);

    document.getElementById('compare-modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            document.getElementById('compare-modal').classList.add('hidden');
        }
    });

    document.getElementById('stock-modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            closeStockModal();
        }
    });

    // Close on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.getElementById('compare-modal').classList.add('hidden');
            closeStockModal();
        }
    });
</script>
{% endblock %}
