{% extends "base.html" %}

{% block title %}Correlations - Stock Clustering{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900">Correlation Pairs</h1>
        <div class="flex items-center space-x-4">
            <label class="text-sm text-gray-500">Min Correlation:</label>
            <select id="min-corr" class="border rounded px-3 py-1">
                <option value="0.9">0.90+</option>
                <option value="0.85">0.85+</option>
                <option value="0.8">0.80+</option>
                <option value="0.75">0.75+</option>
                <option value="0.7" selected>0.70+</option>
            </select>
            <button id="refresh-btn" class="btn-secondary">Refresh</button>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="text-sm text-gray-500 uppercase tracking-wide">Total Pairs</div>
            <div id="stat-pairs" class="text-3xl font-bold text-gray-900 mt-2">-</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="text-sm text-gray-500 uppercase tracking-wide">Highest Correlation</div>
            <div id="stat-max" class="text-3xl font-bold text-green-600 mt-2">-</div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="text-sm text-gray-500 uppercase tracking-wide">Analysis Date</div>
            <div id="stat-date" class="text-xl font-semibold text-gray-900 mt-2">-</div>
        </div>
    </div>

    <!-- Correlation Distribution Chart -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Correlation Distribution</h2>
        <div class="h-48">
            <canvas id="distribution-chart"></canvas>
        </div>
    </div>

    <!-- Comparison Chart Modal -->
    <div id="compare-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center border-b px-6 py-4">
                <h3 id="compare-title" class="text-lg font-semibold text-gray-900">Compare Stocks</h3>
                <button id="close-compare" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <div class="h-80">
                    <canvas id="compare-chart"></canvas>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                    <div id="stock-a-stats" class="p-3 bg-blue-50 rounded">
                        <span id="stock-a-name" class="font-semibold text-blue-700">-</span>
                        <div class="text-gray-600 mt-1">Return: <span id="stock-a-return">-</span></div>
                    </div>
                    <div id="stock-b-stats" class="p-3 bg-green-50 rounded">
                        <span id="stock-b-name" class="font-semibold text-green-700">-</span>
                        <div class="text-gray-600 mt-1">Return: <span id="stock-b-return">-</span></div>
                    </div>
                </div>
                <div id="compare-correlation" class="mt-4 text-center text-gray-600">
                    Correlation: <span class="font-semibold">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Correlation Table -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Correlated Pairs</h2>
        <div class="overflow-x-auto">
            <table class="w-full table-hover">
                <thead>
                    <tr class="text-left text-xs text-gray-500 uppercase border-b">
                        <th class="pb-3 w-8">#</th>
                        <th class="pb-3">Stock A</th>
                        <th class="pb-3">Stock B</th>
                        <th class="pb-3 text-right">Correlation</th>
                        <th class="pb-3 text-center">Strength</th>
                        <th class="pb-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="pairs-table" class="divide-y divide-gray-100">
                    <tr><td colspan="6" class="py-8 text-center text-gray-400">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="load-more" class="mt-4 text-center hidden">
            <button id="load-more-btn" class="btn-secondary">Load More</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let distributionChart = null;
    let currentLimit = 50;

    function getStrengthIndicator(corr) {
        if (corr >= 0.95) return { text: 'Very Strong', class: 'bg-green-600' };
        if (corr >= 0.9) return { text: 'Strong', class: 'bg-green-500' };
        if (corr >= 0.85) return { text: 'Moderate', class: 'bg-blue-500' };
        if (corr >= 0.8) return { text: 'Fair', class: 'bg-blue-400' };
        return { text: 'Weak', class: 'bg-gray-400' };
    }

    async function loadCorrelations(limit = 50) {
        const minCorr = document.getElementById('min-corr').value;

        try {
            const res = await fetch(`/api/correlations?min_corr=${minCorr}&limit=${limit}`);
            const data = await res.json();

            document.getElementById('stat-pairs').textContent = data.count;
            document.getElementById('stat-date').textContent = data.analysis_date;

            if (data.pairs && data.pairs.length > 0) {
                document.getElementById('stat-max').textContent = data.pairs[0].correlation.toFixed(4);

                const tbody = document.getElementById('pairs-table');
                tbody.innerHTML = data.pairs.map((p, i) => {
                    const strength = getStrengthIndicator(p.correlation);
                    const barWidth = Math.round((p.correlation - 0.7) * 333); // Scale 0.7-1.0 to 0-100

                    return `
                        <tr>
                            <td class="py-3 text-sm text-gray-400">${i + 1}</td>
                            <td class="py-3">
                                <a href="/stock/${p.ticker_a}" class="text-blue-600 hover:underline font-medium">${p.ticker_a}</a>
                            </td>
                            <td class="py-3">
                                <a href="/stock/${p.ticker_b}" class="text-blue-600 hover:underline font-medium">${p.ticker_b}</a>
                            </td>
                            <td class="py-3 text-right">
                                <span class="font-mono font-semibold">${p.correlation.toFixed(4)}</span>
                            </td>
                            <td class="py-3">
                                <div class="flex items-center justify-center">
                                    <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="${strength.class} h-full" style="width: ${barWidth}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="py-3 text-center">
                                <button onclick="comparePair('${p.ticker_a}', '${p.ticker_b}', ${p.correlation})"
                                        class="text-xs bg-indigo-500 text-white px-2 py-1 rounded hover:bg-indigo-600 mr-2">
                                    Compare
                                </button>
                                <a href="/stock/${p.ticker_a}" class="text-xs text-blue-600 hover:underline mr-1">${p.ticker_a}</a>
                                <a href="/stock/${p.ticker_b}" class="text-xs text-blue-600 hover:underline">${p.ticker_b}</a>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Show load more if we got full results
                if (data.count >= limit) {
                    document.getElementById('load-more').classList.remove('hidden');
                } else {
                    document.getElementById('load-more').classList.add('hidden');
                }
            } else {
                document.getElementById('pairs-table').innerHTML =
                    '<tr><td colspan="6" class="py-8 text-center text-gray-400">No correlations found</td></tr>';
            }

            // Load distribution chart
            const chartRes = await fetch('/api/charts/correlation-distribution');
            const chartData = await chartRes.json();

            const ctx = document.getElementById('distribution-chart').getContext('2d');
            if (distributionChart) distributionChart.destroy();

            distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Number of Pairs',
                        data: chartData.data,
                        backgroundColor: 'rgba(34, 197, 94, 0.5)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

        } catch (e) {
            console.error('Error loading correlations:', e);
        }
    }

    // Event listeners
    document.getElementById('min-corr').addEventListener('change', () => {
        currentLimit = 50;
        loadCorrelations(currentLimit);
    });

    document.getElementById('refresh-btn').addEventListener('click', () => {
        currentLimit = 50;
        loadCorrelations(currentLimit);
    });

    document.getElementById('load-more-btn').addEventListener('click', () => {
        currentLimit += 50;
        loadCorrelations(currentLimit);
    });

    // Initialize
    loadCorrelations();

    // Comparison chart
    let compareChart = null;

    async function comparePair(tickerA, tickerB, correlation) {
        const modal = document.getElementById('compare-modal');
        modal.classList.remove('hidden');

        document.getElementById('compare-title').textContent = `${tickerA} vs ${tickerB}`;
        document.getElementById('stock-a-name').textContent = tickerA;
        document.getElementById('stock-b-name').textContent = tickerB;
        document.getElementById('compare-correlation').querySelector('span').textContent = correlation.toFixed(4);

        try {
            // Fetch price data for both stocks
            const [resA, resB] = await Promise.all([
                fetch(`/api/stock/${tickerA}/prices`),
                fetch(`/api/stock/${tickerB}/prices`)
            ]);

            const dataA = await resA.json();
            const dataB = await resB.json();

            if (!dataA.prices || !dataB.prices) {
                console.error('No price data available');
                return;
            }

            // Normalize prices to percentage return from start
            const pricesA = dataA.prices;
            const pricesB = dataB.prices;

            const startA = pricesA[0].price;
            const startB = pricesB[0].price;
            const endA = pricesA[pricesA.length - 1].price;
            const endB = pricesB[pricesB.length - 1].price;

            const returnA = ((endA - startA) / startA * 100).toFixed(1);
            const returnB = ((endB - startB) / startB * 100).toFixed(1);

            document.getElementById('stock-a-return').textContent = `${returnA}%`;
            document.getElementById('stock-b-return').textContent = `${returnB}%`;

            // Normalize both to start at 100 for easier comparison
            const normalizedA = pricesA.map(p => ({
                date: p.date,
                value: (p.price / startA) * 100
            }));
            const normalizedB = pricesB.map(p => ({
                date: p.date,
                value: (p.price / startB) * 100
            }));

            // Create chart
            const ctx = document.getElementById('compare-chart').getContext('2d');
            if (compareChart) compareChart.destroy();

            compareChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: normalizedA.map(p => p.date),
                    datasets: [
                        {
                            label: tickerA,
                            data: normalizedA.map(p => p.value),
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: tickerB,
                            data: normalizedB.map(p => p.value),
                            borderColor: 'rgba(34, 197, 94, 1)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${(context.raw - 100).toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            ticks: {
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Indexed Price (Start = 100)'
                            }
                        }
                    }
                }
            });

        } catch (e) {
            console.error('Error loading comparison data:', e);
        }
    }

    // Close modal handlers
    document.getElementById('close-compare').addEventListener('click', () => {
        document.getElementById('compare-modal').classList.add('hidden');
    });

    document.getElementById('compare-modal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
            document.getElementById('compare-modal').classList.add('hidden');
        }
    });

    // Close on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.getElementById('compare-modal').classList.add('hidden');
        }
    });
</script>
{% endblock %}
